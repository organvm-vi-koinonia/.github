name: Dispatch Receiver

# Receives cross-org events from orchestration-start-here and other organs
on:
  repository_dispatch:
    types:
      - organ-health-audit
      - promotion-recommended
      - essay-published
      - distribution-requested
      - governance-updated
      - system-graph-updated
      - salon-recorded
      - curriculum-created

jobs:
  log:
    runs-on: ubuntu-latest
    steps:
      - name: Log received event
        env:
          EVENT_ACTION: ${{ github.event.action }}
          EVENT_PAYLOAD: ${{ toJSON(github.event.client_payload) }}
        run: |
          echo "Received event: $EVENT_ACTION"
          echo "Payload: $EVENT_PAYLOAD"

  essay-published:
    if: github.event.action == 'essay-published'
    runs-on: ubuntu-latest
    steps:
      - name: Create reading group discussion issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const payload = context.payload.client_payload || {};
            const title = payload.essay_title || 'New essay published';
            const url = payload.essay_url || '';
            const organ = payload.source_organ || 'ORGAN-V';
            await github.rest.issues.create({
              owner: 'organvm-vi-koinonia',
              repo: 'reading-group-curriculum',
              title: `[${organ}] Schedule discussion: ${title}`,
              body: [
                `## New Essay Published`,
                ``,
                `**Source:** ${organ}`,
                `**Title:** ${title}`,
                `**URL:** ${url}`,
                ``,
                `### Action Required`,
                `- [ ] Review essay for curriculum relevance`,
                `- [ ] Assign to appropriate curriculum`,
                `- [ ] Schedule reading group session`,
                `- [ ] Generate discussion questions`,
                ``,
                `_Auto-created by ORGAN-VI dispatch-receiver_`,
              ].join('\n'),
              labels: ['essay-published', 'auto-dispatch'],
            });

  governance-updated:
    if: github.event.action == 'governance-updated'
    runs-on: ubuntu-latest
    steps:
      - name: Create compliance check issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const payload = context.payload.client_payload || {};
            const rules = payload.changed_rules || 'unspecified';
            await github.rest.issues.create({
              owner: 'organvm-vi-koinonia',
              repo: 'community-hub',
              title: `[ORGAN-IV] Governance rules updated`,
              body: [
                `## Governance Update Received`,
                ``,
                `**Changed rules:** ${rules}`,
                `**Source:** ORGAN-IV orchestration-start-here`,
                ``,
                `### Compliance Checklist`,
                `- [ ] Review updated governance rules`,
                `- [ ] Check salon-archive compliance`,
                `- [ ] Check reading-group-curriculum compliance`,
                `- [ ] Check community-hub compliance`,
                `- [ ] Update ORGAN-VI procedures if needed`,
                ``,
                `_Auto-created by ORGAN-VI dispatch-receiver_`,
              ].join('\n'),
              labels: ['governance', 'auto-dispatch'],
            });

  promotion-recommended:
    if: github.event.action == 'promotion-recommended'
    runs-on: ubuntu-latest
    steps:
      - name: Create promotion review issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const payload = context.payload.client_payload || {};
            const repo = payload.repo || 'unknown';
            const details = payload.details || 'No details provided';
            const target = (repo === '.github' || repo === 'unknown')
              ? 'community-hub' : repo;
            await github.rest.issues.create({
              owner: 'organvm-vi-koinonia',
              repo: target,
              title: `[META] Promotion recommended: ${repo}`,
              body: [
                `## Promotion Recommendation`,
                ``,
                `**Repository:** ${repo}`,
                `**Details:** ${details}`,
                ``,
                `### Review`,
                `- [ ] Verify README quality`,
                `- [ ] Verify CI passing`,
                `- [ ] Verify test coverage`,
                `- [ ] Approve promotion`,
                ``,
                `_Auto-created by ORGAN-VI dispatch-receiver_`,
              ].join('\n'),
              labels: ['promotion', 'auto-dispatch'],
            });
