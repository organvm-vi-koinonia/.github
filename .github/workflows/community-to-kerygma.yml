name: Community → Kerygma

# Edge 5 (VI→VII): When an issue is labeled 'community-approved',
# validates RFC gate (7-day age) + quality threshold, then dispatches
# community.milestone to ORGAN-VII for announcement distribution.

on:
  issues:
    types: [labeled]

jobs:
  dispatch-milestone:
    if: github.event.label.name == 'community-approved'
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Validate RFC gate
        id: gates
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUM: ${{ github.event.issue.number }}
          REPO_FULL: ${{ github.repository }}
          ISSUE_CREATED: ${{ github.event.issue.created_at }}
        run: |
          # Gate 1: RFC period — issue must be at least 7 days old
          AGE_DAYS=$(python3 -c "
          from datetime import datetime, timezone
          import os
          created = datetime.fromisoformat(os.environ['ISSUE_CREATED'].replace('Z', '+00:00'))
          now = datetime.now(timezone.utc)
          print((now - created).days)
          ")

          echo "Issue age: ${AGE_DAYS} days"
          if [ "$AGE_DAYS" -ge 7 ]; then
            echo "rfc_passed=true" >> "$GITHUB_OUTPUT"
          else
            echo "rfc_passed=false" >> "$GITHUB_OUTPUT"
            echo "age_days=${AGE_DAYS}" >> "$GITHUB_OUTPUT"
          fi

          # Gate 2: quality-threshold label
          LABELS=$(gh issue view "$ISSUE_NUM" --repo "$REPO_FULL" --json labels --jq '.labels[].name' 2>/dev/null || echo "")
          QUALITY_OK=$(echo "$LABELS" | grep -c "quality-threshold" || true)
          if [ "$QUALITY_OK" -ge 1 ]; then
            echo "quality_passed=true" >> "$GITHUB_OUTPUT"
          else
            echo "quality_passed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Dispatch community.milestone
        if: steps.gates.outputs.rfc_passed == 'true' && steps.gates.outputs.quality_passed == 'true'
        env:
          GH_TOKEN: ${{ secrets.ORCHESTRATION_PAT || secrets.GITHUB_TOKEN }}
          REPO_FULL: ${{ github.repository }}
          ISSUE_NUM: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          PAYLOAD=$(python3 -c "
          import json, os
          print(json.dumps({
              'source_repo': os.environ['REPO_FULL'],
              'source_organ': 'ORGAN-VI',
              'issue_number': os.environ['ISSUE_NUM'],
              'issue_title': os.environ['ISSUE_TITLE'],
              'milestone_type': 'community-approved',
              'triggered_by': 'community-to-kerygma',
          }))
          ")

          gh api repos/organvm-vii-kerygma/.github/dispatches \
            --method POST \
            -f event_type=community.milestone \
            -f "client_payload=${PAYLOAD}"

          echo "Dispatched community.milestone to ORGAN-VII"

      - name: Comment gate failure
        if: steps.gates.outputs.rfc_passed == 'false' || steps.gates.outputs.quality_passed == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const rfcPassed = '${{ steps.gates.outputs.rfc_passed }}' === 'true';
            const qualityPassed = '${{ steps.gates.outputs.quality_passed }}' === 'true';
            const ageDays = '${{ steps.gates.outputs.age_days }}' || '?';

            let reasons = [];
            if (!rfcPassed) reasons.push(`RFC period not met (${ageDays}/7 days)`);
            if (!qualityPassed) reasons.push('Missing quality-threshold label');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `**Community milestone dispatch blocked.**\n\n${reasons.map(r => '- ' + r).join('\n')}\n\nResolve and re-apply community-approved to retry.\n\n---\n*Generated by community-to-kerygma workflow*`
            });
