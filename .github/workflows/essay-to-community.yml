name: Essay to Community

# Edge 4 receiver (Vâ†’VI): Receives essay.published dispatch from
# ORGAN-IV essay-monitor and creates tracking issues in
# reading-group-curriculum for curator review.
# Also polls daily at 11:00 UTC as a fallback.

on:
  repository_dispatch:
    types:
      - essay-published
  schedule:
    - cron: '0 11 * * *'
  workflow_dispatch:

jobs:
  handle-dispatch:
    if: github.event_name == 'repository_dispatch'
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Extract essay details
        id: extract
        env:
          EVENT_PAYLOAD: ${{ toJSON(github.event.client_payload) }}
        run: |
          TITLE=$(echo "$EVENT_PAYLOAD" | jq -r '.essay_title // "Untitled"')
          URL=$(echo "$EVENT_PAYLOAD" | jq -r '.essay_url // ""')
          DATE=$(echo "$EVENT_PAYLOAD" | jq -r '.essay_date // ""')
          SOURCE=$(echo "$EVENT_PAYLOAD" | jq -r '.source_repo // "organvm-v-logos/public-process"')

          echo "title=${TITLE}" >> "$GITHUB_OUTPUT"
          echo "url=${URL}" >> "$GITHUB_OUTPUT"
          echo "date=${DATE}" >> "$GITHUB_OUTPUT"
          echo "source=${SOURCE}" >> "$GITHUB_OUTPUT"

      - name: Check for existing tracking issue
        id: check
        env:
          GH_TOKEN: ${{ secrets.CROSS_ORG_TOKEN || secrets.GITHUB_TOKEN }}
          ESSAY_TITLE: ${{ steps.extract.outputs.title }}
        run: |
          EXISTING=$(gh issue list \
            --repo organvm-vi-koinonia/reading-group-curriculum \
            --search "Essay Review: ${ESSAY_TITLE} in:title" \
            --state all --json title --limit 3 2>/dev/null || echo "[]")
          COUNT=$(echo "$EXISTING" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          print(len([i for i in data if 'Essay Review' in i.get('title','')]))
          " 2>/dev/null || echo "0")
          echo "exists=$( [ "$COUNT" -gt 0 ] && echo true || echo false )" >> "$GITHUB_OUTPUT"

      - name: Create tracking issue
        if: steps.check.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.CROSS_ORG_TOKEN || secrets.GITHUB_TOKEN }}
          ESSAY_TITLE: ${{ steps.extract.outputs.title }}
          ESSAY_URL: ${{ steps.extract.outputs.url }}
          ESSAY_DATE: ${{ steps.extract.outputs.date }}
          ESSAY_SOURCE: ${{ steps.extract.outputs.source }}
        run: |
          cat > essay_body.md << ISSUE_BODY
          ## New Essay for Community Review

          **Title:** ${ESSAY_TITLE}
          **Published:** ${ESSAY_DATE}
          **URL:** ${ESSAY_URL}
          **Source:** ${ESSAY_SOURCE}

          ### Curator Actions

          - [ ] Read and assess relevance to active reading programs
          - [ ] Identify discussion themes and connections to existing curricula
          - [ ] Decide: add to existing program or create standalone discussion
          - [ ] If relevant, create reading session entry

          ### Community Integration

          Consider how this essay connects to:
          - Active reading group curricula
          - Upcoming salon topics
          - Adaptive syllabus recommendations

          ---
          *Generated by essay-to-community.yml (Edge 4: V->VI)*
          ISSUE_BODY

          gh issue create \
            --repo organvm-vi-koinonia/reading-group-curriculum \
            --title "Essay Review: ${ESSAY_TITLE}" \
            --body-file essay_body.md \
            --label "essay-review" \
            --label "from-logos" \
            || echo "Issue creation failed -- may need CROSS_ORG_TOKEN"

  handle-poll:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Poll for recent essays
        id: poll
        env:
          GH_TOKEN: ${{ secrets.CROSS_ORG_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          python3 << 'POLL_ESSAYS'
          import json
          import os
          import subprocess
          import sys
          from datetime import datetime, timedelta, timezone

          def gh_api(endpoint):
              result = subprocess.run(
                  ['gh', 'api', endpoint],
                  capture_output=True, text=True
              )
              if result.returncode != 0:
                  return None
              try:
                  return json.loads(result.stdout)
              except json.JSONDecodeError:
                  return None

          posts = gh_api('repos/organvm-v-logos/public-process/contents/_posts')
          if not posts:
              print("No posts found or access denied")
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write("essay_count=0\n")
              sys.exit(0)

          now = datetime.now(timezone.utc).replace(tzinfo=None)
          cutoff = now - timedelta(days=2)

          essays = []
          for post in posts:
              name = post.get('name', '')
              if not name.endswith('.md'):
                  continue
              parts = name.split('-', 3)
              if len(parts) < 4:
                  continue
              try:
                  post_date = datetime(int(parts[0]), int(parts[1]), int(parts[2]))
              except (ValueError, IndexError):
                  continue
              if post_date >= cutoff:
                  slug = parts[3].replace('.md', '')
                  title = slug.replace('-', ' ').title()
                  url = (
                      f"https://organvm-v-logos.github.io/public-process/"
                      f"{post_date.strftime('%Y/%m/%d')}/{slug}/"
                  )
                  essays.append({
                      'title': title,
                      'url': url,
                      'date': post_date.strftime('%Y-%m-%d'),
                  })

          # Check for existing issues and create new ones
          for essay in essays:
              existing = subprocess.run(
                  ['gh', 'issue', 'list',
                   '--repo', 'organvm-vi-koinonia/reading-group-curriculum',
                   '--search', f"Essay Review: {essay['title']} in:title",
                   '--state', 'all', '--json', 'title', '--limit', '3'],
                  capture_output=True, text=True
              )
              try:
                  items = json.loads(existing.stdout)
                  if any('Essay Review' in i.get('title', '') for i in items):
                      continue
              except json.JSONDecodeError:
                  pass

              body = f"""## New Essay for Community Review

          **Title:** {essay['title']}
          **Published:** {essay['date']}
          **URL:** {essay['url']}
          **Source:** organvm-v-logos/public-process

          ### Curator Actions

          - [ ] Read and assess relevance to active reading programs
          - [ ] Identify discussion themes
          - [ ] Decide: add to existing program or standalone discussion

          ---
          *Generated by essay-to-community.yml fallback poll (Edge 4: V->VI)*
          """

              with open('poll_body.md', 'w') as f:
                  import textwrap
                  f.write(textwrap.dedent(body))

              subprocess.run(
                  ['gh', 'issue', 'create',
                   '--repo', 'organvm-vi-koinonia/reading-group-curriculum',
                   '--title', f"Essay Review: {essay['title']}",
                   '--body-file', 'poll_body.md',
                   '--label', 'essay-review',
                   '--label', 'from-logos'],
                  capture_output=True, text=True
              )
              print(f"Created: Essay Review: {essay['title']}")

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"essay_count={len(essays)}\n")

          print(f"Processed {len(essays)} recent essays")
          POLL_ESSAYS
